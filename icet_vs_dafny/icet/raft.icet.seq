prog(raft_single, [decl(f,set),decl(c,set),decl(voted,map(set(f),int)),decl(id,map(set(f),int)),decl(term,map(set(f),int)),decl(fterm,map(set(f),int)),decl(voted,map(set(f),int)),decl(votes,map(set(f),map(int,int))),decl(votedFor,map(set(f),int)),decl(success_f,map(set(f),int)),decl(count,map(set(c),int)),decl(isLeader,map(set(c),int)),decl(cterm,map(set(c),int)),decl(success_c,map(set(c),int)),decl(k,map(set(c),int)),decl(l,map(set(c),int)),decl(f0,int)], ensures(forall([decl(i,int),decl(j,int)],implies(and([elem(i,c),elem(j,c),ref(cterm,i)=ref(cterm,j),ref(isLeader,j)=1,ref(isLeader,i)=1]),i=j))), seq([for(_,A,c,r,true,atomic(seq([pre(A,and([ref(k,A)=card(f),ref(l,A)=0,ref(count,A)=0,ref(isLeader,A)=0])),assign(A,count,0),assign(A,isLeader,0),assume(A,forall([decl(i,int)],ref(k,i)=card(f))),assume(A,forall([decl(i,int)],ref(l,i)=0))]))),sym(B,f,seq([for(B,C,c,_,true,seq([atomic(seq([pre(C,forall([decl(i,int)],implies(elem(i,c),and([ref(k,i)+ref(l,i)=<card(f),ref(count,i)=ref(l,i)])))),assign(B,pair(id,term),C,pair(C,cterm)),ite(B,ref(fterm,B)<ref(term,B),seq([assign(B,fterm,term),assign(B,voted,0),assign(B,votedFor,0),ite(B,and([ref(fterm,B)=<ref(term,B),implies(ref(voted,B)=1,ref(votedFor,B)=ref(id,B))]),seq([assign(B,voted,1),assign(B,votedFor,id),assign(B,votes,upd(votes,fterm,id)),assign(B,success_f,1)]),seq([assign(B,success_f,0)]))]),seq([ite(B,and([ref(fterm,B)=<ref(term,B),implies(ref(voted,B)=1,ref(votedFor,B)=ref(id,B))]),seq([assign(B,voted,1),assign(B,votedFor,id),assign(B,votes,upd(votes,fterm,id)),assign(B,success_f,1)]),seq([assign(B,success_f,0)]))])),assign(C,success_c,B,success_f),ite(C,ref(success_c,C)=1,seq([assign(C,count,ref(count,C)+1)]),skip),ite(C,and([ref(success_c,C)=1,ref(votedFor,B)=C,ref(fterm,B)=ref(cterm,C)]),seq([assign(C,l,ref(l,C)+1),assign(C,k,ref(k,C)-1),assume(C,0<ref(l,C)),assume(C,0=<ref(k,C))]),skip)]))])),for(_,A,c,r,true,atomic(seq([pre(A,forall([decl(i,int)],implies(and([elem(i,c),ref(isLeader,i)=1]),card(f)<ref(count,i)*2))),assume(A,forall([decl(i,int)],0=<ref(k,i))),assume(A,forall([decl(i,int)],0=<ref(l,i))),assume(A,elem(f0,f)),assume(A,forall([decl(i,int),decl(j,int)],implies(and([elem(i,c),elem(j,c),ref(l,i)>card(f)/2,ref(l,j)>card(f)/2]),and([ref(ref(votes,f0),ref(cterm,i))=i,ref(ref(votes,f0),ref(cterm,j))=j,ref(cterm,i)=<ref(fterm,f0),ref(cterm,i)=<ref(fterm,f0)])))),pre(A,forall([decl(i,int),decl(j,int)],implies(and([elem(i,c),elem(j,c),ref(count,i)>card(f)/2,ref(count,j)>card(f)/2,ref(cterm,i)=ref(cterm,j),ref(isLeader,j)=1,ref(isLeader,i)=1]),i=j))),ite(A,card(f)<2*ref(count,A),seq([assign(A,isLeader,1)]),skip)])))]))])).
