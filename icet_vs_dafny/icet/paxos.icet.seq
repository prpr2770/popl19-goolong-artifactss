prog(paxos, [decl(p,set),decl(a,set),decl(dc,map(set(p),int)),decl(t,map(set(p),int)),decl(w_t,map(set(p),int)),decl(w,map(set(p),int)),decl(x_t,map(set(p),int)),decl(x,map(set(p),int)),decl(ho,map(set(p),int)),decl(ready,map(set(p),int)),decl(retType,map(set(p),int)),decl(decided,map(set(p),int)),decl(p0,int),decl(a0,int),decl(k,map(set(p),int)),decl(l,map(set(p),int)),decl(m,map(set(p),int)),decl(id,map(set(a),int)),decl(msgType,map(set(a),int)),decl(seqno,map(set(a),int)),decl(val,map(set(a),int)),decl(max,map(set(a),int)),decl(a_w,map(set(a),int)),decl(a_w_t,map(set(a),int)),decl(bottom,map(set(a),int))], ensures(forall([decl(aa,int),decl(p1,int),decl(p2,int)],implies(and([elem(aa,a),elem(p1,p),elem(p2,p),ref(decided,p1)=1,ref(decided,p2)=1,implies(and([ref(k,p1)>card(a)/2,ref(k,p2)>card(a)/2]),and([ref(t,p1)=<ref(a_w_t,aa),ref(t,p2)=<ref(a_w_t,aa)])),0=<ref(l,p1),0=<ref(l,p2)]),ref(x,p1)=ref(x,p2)))), seq([for(_,A,p,r,true,atomic(seq([pre(A,ref(ready,A)=0),pre(A,ref(decided,A)=0),pre(A,ref(ho,A)=0),pre(A,ref(t,A)>0),pre(A,and([ref(k,A)=0,ref(l,A)=card(a),ref(m,A)=0])),assign(A,ho,0),assign(A,ready,0),assign(A,decided,0),assume(A,forall([decl(i,int)],and([ref(m,i)=0,ref(l,i)=card(a),ref(k,i)=0,ref(t,i)>0])))]))),for(_,B,a,r,true,atomic(seq([pre(B,ref(a_w_t,B)=0),assign(B,max,bottom),assign(B,a_w,bottom),assign(B,a_w_t,0)]))),sym(A,p,seq([for(A,B,a,_,true,seq([atomic(seq([pre(A,forall([decl(i,int)],implies(and([elem(i,p),here(i)]),and([ref(ready,i)=0,ref(decided,i)=0,ref(k,i)=0])))),pre(A,forall([decl(i,int)],implies(and([elem(i,p),here(i)]),ref(k,i)+ref(l,i)+ref(m,i)=card(a)))),assume(A,forall([decl(i,int)],implies(ref(t,i)=ref(t,A),i=A))),assume(A,forall([decl(i,int)],implies(and([elem(i,p),ref(l,i)>card(a)/2]),or([ref(ready,A)=0,ref(t,A)<ref(t,i)])))),assume(A,elem(a0,a)),assume(A,implies(and([0=<ref(x_t,A)]),and([ref(x,A)=ref(a_w,a0),ref(x_t,A)=ref(a_w_t,a0)]))),assume(A,forall([decl(i,int)],implies(and([elem(i,p),ref(ready,i)=1,ref(k,i)+ref(l,i)>card(a)/2,ref(ready,A)=1]),and([ref(t,i)=<ref(x_t,A),0=<ref(x_t,A)])))),assign(B,pair(id,pair(msgType,pair(seqno,val))),A,pair(A,pair(0,pair(t,dc)))),ite(B,ref(msgType,B)=0,seq([ite(B,ref(seqno,B)>ref(max,B),seq([assign(B,max,seqno),ite(B,ref(t,p0)=<ref(max,B),seq([assume(B,ref(l,p0)>0),assign(p0,l,upd(l,p0,ref(l,p0)-1)),assign(p0,m,upd(m,p0,ref(m,p0)+1))]),skip)]),skip)]),seq([ite(B,ref(max,B)=<ref(seqno,B),seq([assign(B,a_w,val),assign(B,a_w_t,seqno)]),skip)])),assign(A,pair(dc,pair(w_t,w)),B,pair(1,pair(a_w_t,a_w))),ite(A,ref(w_t,A)>ref(x_t,A),seq([assign(A,x_t,w_t),assign(A,x,w),assign(A,ho,ref(ho,A)+1)]),skip)]))])),ite(A,ref(ho,A)>card(a)/2,seq([pre(A,forall([decl(i,int)],implies(and([elem(i,p),ref(decided,i)=1]),and([ref(k,i)>card(a)/2,ref(ho,i)>card(a)/2,ref(ready,i)=1])))),pre(A,forall([decl(i,int)],implies(and([elem(i,p),here(i)]),and([ref(decided,i)=0,ref(k,i)=0])))),pre(A,forall([decl(i,int)],implies(and([elem(i,p),here(i)]),ref(k,i)+ref(l,i)+ref(m,i)=card(a)))),assign(A,ho,0),assign(A,ready,1),for(A,B,a,_,true,seq([atomic(seq([pre(A,forall([decl(i,int)],implies(and([elem(i,p),here(i)]),and([ref(ready,i)=1,ref(decided,i)=0])))),pre(A,forall([decl(i,int)],implies(and([elem(i,p),here(i)]),and([ref(ready,i)=1,ref(ho,i)=<ref(k,i)])))),pre(A,forall([decl(i,int)],implies(and([elem(i,p),here(i)]),ref(k,i)+ref(l,i)+ref(m,i)=card(a)))),pre(A,forall([decl(i,int),decl(j,int)],implies(and([elem(i,p),elem(j,a),ref(l,i)>card(a)/2,ref(k,i)=0]),ref(a_w_t,j)<ref(t,i)))),pre(A,forall([decl(qa,int),decl(qp,int)],implies(and([elem(qa,a),elem(qp,p),ref(ready,qp)=1,ref(t,qp)=<ref(a_w_t,qa),ref(k,qp)+ref(l,qp)>card(a)/2]),ref(a_w,qa)=ref(x,qp)))),assume(A,forall([decl(i,int)],implies(ref(t,i)=ref(t,A),i=A))),assume(A,forall([decl(i,int)],implies(and([elem(i,p),ref(l,i)>card(a)/2]),or([ref(ready,A)=0,ref(t,A)<ref(t,i)])))),assume(A,elem(a0,a)),assume(A,implies(and([0=<ref(x_t,A)]),and([ref(x,A)=ref(a_w,a0),ref(x_t,A)=ref(a_w_t,a0)]))),assume(A,forall([decl(i,int)],implies(and([elem(i,p),ref(ready,i)=1,ref(k,i)+ref(l,i)>card(a)/2,ref(ready,A)=1]),and([ref(t,i)=<ref(x_t,A),0=<ref(x_t,A)])))),assign(B,pair(id,pair(msgType,pair(seqno,val))),A,pair(A,pair(1,pair(t,x)))),ite(B,ref(msgType,B)=0,seq([ite(B,ref(seqno,B)>ref(max,B),seq([assign(B,max,seqno),ite(B,ref(t,p0)=<ref(max,B),seq([assume(B,ref(l,p0)>0),assign(p0,l,upd(l,p0,ref(l,p0)-1)),assign(p0,m,upd(m,p0,ref(m,p0)+1))]),skip)]),skip)]),seq([ite(B,ref(max,B)=<ref(seqno,B),seq([assign(B,a_w,val),assign(B,a_w_t,seqno)]),skip)])),assign(A,pair(retType,pair(dc,dc)),B,pair(1,pair(a_w_t,a_w))),assign(A,ho,ref(ho,A)+1),assign(A,k,ref(k,A)+1),assign(A,l,ref(l,A)-1),assume(A,and([ref(k,A)>0,0=<ref(l,A)]))]))])),ite(A,2*ref(ho,A)>card(a),seq([pre(A,forall([decl(i,int)],implies(and([elem(i,p),here(i)]),ref(ready,i)=1))),pre(A,forall([decl(i,int)],implies(and([elem(i,p),here(i)]),and([ref(ready,i)=1,ref(ho,i)=<ref(k,i)])))),pre(A,forall([decl(i,int)],implies(and([elem(i,p),here(i)]),ref(k,i)+ref(l,i)+ref(m,i)=card(a)))),assign(A,decided,1)]),skip)]),skip)]))])).
